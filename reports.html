<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RK Knit Fab â€” Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Inter,Arial;background:#f4f6fb;margin:0}
.card{max-width:1300px;margin:16px auto;background:#fff;
padding:16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.filters{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
input,select,button{padding:10px;border-radius:8px;border:1px solid #ccc}
button{background:#111;color:#fff;font-weight:600;cursor:pointer}
table{width:100%;margin-top:14px;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#f1f1f1}
td input{width:100%;border:none;background:transparent;text-align:center}
@media(max-width:900px){.filters{grid-template-columns:repeat(2,1fr)}}
@media(max-width:520px){.filters{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="card">
<h3>All Entries Report</h3>

<div class="filters">
<input type="date" id="from">
<input type="date" id="to">
<input placeholder="Party filter" id="partyFilter">
<input placeholder="Item filter" id="itemFilter">
<button onclick="load()">Apply</button>
</div>

<table>
<thead>
<tr>
<th>Date</th><th>Bill</th><th>Party</th><th>Location</th>
<th>Item</th><th>Lot No</th><th>Weight</th>
<th>Rate</th><th>Total</th><th>Transport</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<script>
const API = "https://bill-update-a82a.rkknitfabsachin.workers.dev"; // reports worker

let cache = [];

/* LOAD DATA */
function load(){
  const qs =
    `?action=getReports&from=${from.value}&to=${to.value}`;

  fetch(API + qs)
    .then(r=>r.json())
    .then(d=>{
      cache = d;
      render();
    });
}

/* RENDER */
function render(){
  rows.innerHTML="";
  cache
    .filter(r=>{
      if(partyFilter.value && !r.party.toLowerCase().includes(partyFilter.value.toLowerCase())) return false;
      if(itemFilter.value && !r.item.toLowerCase().includes(itemFilter.value.toLowerCase())) return false;
      return true;
    })
    .forEach(r=>{
      rows.innerHTML+=`
      <tr>
        <td><input value="${r.date.split('T')[0]}" onchange="edit(${r.row},'date',this.value)"></td>
        <td><input value="${r.bill}" onchange="edit(${r.row},'bill',this.value)"></td>
        <td><input value="${r.party}" onchange="edit(${r.row},'party',this.value)"></td>
        <td><input value="${r.location}" onchange="edit(${r.row},'location',this.value)"></td>
        <td><input value="${r.item}" onchange="edit(${r.row},'item',this.value)"></td>
        <td><input value="${r.lotno}" onchange="edit(${r.row},'lotno',this.value)"></td>
        <td><input value="${r.weight}" onchange="edit(${r.row},'weight',this.value)"></td>
        <td><input value="${r.rate}" onchange="edit(${r.row},'rate',this.value)"></td>
        <td>${r.total}</td>
        <td><input value="${r.transport}" onchange="edit(${r.row},'transport',this.value)"></td>
      </tr>`;
    });
}

/* EDIT & SAVE */
function edit(row, field, value){
  const r = cache.find(x=>x.row===row);
  r[field] = value;
  r.total = (r.weight * r.rate).toFixed(2);

  fetch(API+"?action=updateReport",{
    method:"POST",
    body:JSON.stringify(r)
  });
}

/* INIT */
load();
</script>
</body>
</html>
