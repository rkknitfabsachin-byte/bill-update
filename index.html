<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RK Knit Fab ‚Äî Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Inter,Arial;background:#f4f6fb;margin:0}
.card{max-width:1000px;margin:16px auto;background:#fff;
padding:16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
input,select,button{padding:10px;border-radius:8px;border:1px solid #ddd}
button{background:#111;color:#fff;font-weight:600;cursor:pointer}
table{width:100%;margin-top:14px;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#f1f1f1}
.popup{display:none;position:fixed;top:20px;right:20px;
background:#111;color:#fff;padding:12px 16px;border-radius:10px}
</style>
</head>

<body>

<div class="popup" id="popup">Entries saved successfully ‚úî</div>

<div class="card">
<h3>Fabric Entry</h3>

<div class="grid">
<input type="date" id="date">
<input placeholder="Bill No" id="bill">
<input list="partyList" placeholder="Party" id="party">
<select id="location"><option value="">Location</option></select>

<input placeholder="No of Rolls" id="rolls">
<input list="itemList" placeholder="Item" id="item">
<input placeholder="Width" id="width">
<input list="colourList" placeholder="Colour" id="colour">

<input placeholder="Weight" id="weight">
<input placeholder="Rate" id="rate">
<input placeholder="Total" id="total" readonly>
<select id="transport"><option value="">Transport</option></select>

<input placeholder="Entry Name" id="entry">
</div>

<br>
<button onclick="addEntry()">Add Entry</button>
<button onclick="saveAll()">Save All</button>

<table>
<thead>
<tr>
<th>Date</th><th>Bill</th><th>Party</th><th>Item</th>
<th>Weight</th><th>Rate</th><th>Total</th><th>‚ùå</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<datalist id="partyList"></datalist>
<datalist id="itemList"></datalist>
<datalist id="colourList"></datalist>

<script>
// üî¥ PASTE YOUR WORKER URL HERE
const API = "https://bill-update-a82a.rkknitfabsachin.workers.dev";

let entries = [];

// INIT
fetch(API + "?action=init")
  .then(r => r.text())
  .then(t => JSON.parse(t))
  .then(d => {
    fill("partyList", d.parties);
    fill("itemList", d.items);
    fill("colourList", d.colours);
  });

// UTIL
function fill(id, arr){
  document.getElementById(id).innerHTML =
    arr.map(v=>`<option value="${v}">`).join("");
}

function fillSelect(sel, arr){
  sel.innerHTML='<option value=""></option>';
  arr.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    sel.appendChild(o);
  });
}

// PARTY CHANGE
party.addEventListener("change",()=>{
  fetch(API+"?action=partyDetails&party="+encodeURIComponent(party.value))
    .then(r=>r.text())
    .then(t=>JSON.parse(t))
    .then(d=>{
      fillSelect(location,d.locations||[]);
      fillSelect(transport,d.transports||[]);
    });
});

// TOTAL
[weight,rate].forEach(i=>i.oninput=()=>{
  total.value=((+weight.value||0)*(+rate.value||0)).toFixed(2);
});

// ADD ENTRY
function addEntry(){
  entries.push({
    date:date.value,
    bill:bill.value,
    party:party.value,
    location:location.value,
    rolls:rolls.value,
    item:item.value,
    width:width.value,
    lotno:"",
    colour:colour.value,
    weight:weight.value,
    rate:rate.value,
    transport:transport.value,
    total:total.value,
    entry:entry.value
  });
  render();
}

// RENDER
function render(){
  rows.innerHTML="";
  entries.forEach((e,i)=>{
    rows.innerHTML+=`
      <tr>
        <td>${e.date}</td>
        <td>${e.bill}</td>
        <td>${e.party}</td>
        <td>${e.item}</td>
        <td>${e.weight}</td>
        <td>${e.rate}</td>
        <td>${e.total}</td>
        <td onclick="entries.splice(${i},1);render()">‚ùå</td>
      </tr>`;
  });
}

// SAVE ALL
function saveAll(){
  fetch(API+"?action=saveBulk",{
    method:"POST",
    body:JSON.stringify({rows:entries})
  })
  .then(r=>r.text())
  .then(()=> {
    entries=[];
    render();
    showPopup();
  });
}

function showPopup(){
  popup.style.display="block";
  setTimeout(()=>popup.style.display="none",2500);
}

date.valueAsDate=new Date();
</script>
</body>
</html>
