<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RK Knit Fab ‚Äî Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;background:#f4f6fb;margin:0}
.card{max-width:1200px;margin:14px auto;background:#fff;
padding:16px;border-radius:14px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
input,select,button{
  padding:9px;border-radius:7px;border:1px solid #ccc;font-size:13px
}
button{background:#111;color:#fff;font-weight:600}
table{width:100%;margin-top:12px;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#f1f1f1}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:520px){.grid{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="card">
<h3>Fabric Entry</h3>

<div class="grid">
<input type="date" id="date">
<input placeholder="Bill No" id="bill">

<input list="partyList" placeholder="Party" id="party">
<select id="location"><option value="">Location</option></select>

<input placeholder="No of Rolls" id="rolls">
<input list="itemList" placeholder="Item" id="item">

<input placeholder="Width" id="width">
<input placeholder="Lot No" id="lotno">

<input list="colourList" placeholder="Colour" id="colour">
<input placeholder="Weight" id="weight">
<input placeholder="Rate" id="rate">
<input placeholder="Total" id="total" readonly>

<select id="transport"><option value="">Transport</option></select>
<input placeholder="Entry Name" id="entryName">
</div>

<br>
<button onclick="addEntry()">Add Entry</button>
<button onclick="saveAll()">Save All</button>

<table>
<thead>
<tr>
<th>Date</th><th>Bill</th><th>Party</th><th>Item</th>
<th>Lot</th><th>Weight</th><th>Total</th>
<th>‚úèÔ∏è</th><th>üìÑ</th><th>‚ùå</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<datalist id="partyList"></datalist>
<datalist id="itemList"></datalist>
<datalist id="colourList"></datalist>

<script>
const API = "https://bill-update-a82a.rkknitfabsachin.workers.dev";

let entries = [];
let editIndex = null;

/* INIT */
fetch(API+"?action=init")
  .then(r=>r.json())
  .then(d=>{
    fill("partyList",d.parties);
    fill("itemList",d.items);
    fill("colourList",d.colours);
  });

function fill(id,arr){
  document.getElementById(id).innerHTML =
    arr.map(v=>`<option value="${v}">`).join("");
}

/* PARTY CHANGE */
party.addEventListener("change",()=>{
  fetch(API+"?action=partydetails&party="+encodeURIComponent(party.value))
    .then(r=>r.json())
    .then(d=>{
      fillSelect(location,d.locations);
      fillSelect(transport,d.transports);
    });
});

function fillSelect(sel,arr){
  sel.innerHTML="<option value=''></option>";
  arr.forEach(v=>{
    const o=document.createElement("option");
    o.value=v;o.textContent=v;
    sel.appendChild(o);
  });
}

/* TOTAL AUTO */
["weight","rate"].forEach(id=>{
  document.getElementById(id).addEventListener("input",()=>{
    total.value=((+weight.value||0)*(+rate.value||0)).toFixed(2);
  });
});

/* FORM DATA */
function readForm(){
  return {
    date:date.value,bill:bill.value,party:party.value,
    location:location.value,rolls:rolls.value,
    item:item.value,width:width.value,lotno:lotno.value,
    colour:colour.value,weight:weight.value,rate:rate.value,
    transport:transport.value,total:total.value,
    entry:entryName.value
  };
}

/* ADD / UPDATE */
function addEntry(){
  if(editIndex===null){
    entries.push(readForm());
  }else{
    entries[editIndex]=readForm();
    editIndex=null;
  }
  clearForm();
  render();
}

/* EDIT */
function editRow(i){
  const e=entries[i];
  editIndex=i;
  date.value=e.date;bill.value=e.bill;party.value=e.party;
  rolls.value=e.rolls;item.value=e.item;width.value=e.width;
  lotno.value=e.lotno;colour.value=e.colour;
  weight.value=e.weight;rate.value=e.rate;
  total.value=e.total;entryName.value=e.entry;

  fetch(API+"?action=partydetails&party="+encodeURIComponent(e.party))
    .then(r=>r.json())
    .then(d=>{
      fillSelect(location,d.locations);
      fillSelect(transport,d.transports);
      location.value=e.location;
      transport.value=e.transport;
    });
}

/* DUPLICATE */
function duplicateRow(i){
  entries.push(JSON.parse(JSON.stringify(entries[i])));
  render();
}

/* RENDER */
function render(){
  rows.innerHTML="";
  entries.forEach((e,i)=>{
    rows.innerHTML+=`
    <tr>
      <td>${e.date}</td><td>${e.bill}</td><td>${e.party}</td>
      <td>${e.item}</td><td>${e.lotno}</td>
      <td>${e.weight}</td><td>${e.total}</td>
      <td onclick="editRow(${i})">‚úèÔ∏è</td>
      <td onclick="duplicateRow(${i})">üìÑ</td>
      <td onclick="entries.splice(${i},1);render()">‚ùå</td>
    </tr>`;
  });
}

/* SAVE */
function saveAll(){
  fetch(API+"?action=savebulk",{
    method:"POST",
    body:JSON.stringify({rows:entries})
  }).then(()=>{
    entries=[];
    render();
    alert("Entries saved successfully");
  });
}

function clearForm(){
  document.querySelectorAll("input").forEach(i=>{
    if(i.type!=="date") i.value="";
  });
}

date.valueAsDate=new Date();
</script>
</body>
</html>
